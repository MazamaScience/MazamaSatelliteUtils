---
title: "GOES Grid Subsets"
author: "Jonathan Callahan"
date: "4/11/2019"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 7,
                      fig.height = 5)
```

Starting from 2019-04-03:

```{r load_data}
library(MazamaSpatialUtils)
library(ncdf4)
library(raster)
library(rgdal)
library(dplyr)
library(tidyr)
library(purrr)

source("../R/utils-goes.R")

setSpatialDataDir('~/Data/Spatial')

# load .nc file
file_path <- file.path('../local_data','OR_ABI-L2-AODC-M3_G16_s20190781512186_e20190781514559_c20190781516459.nc')
nc <- ncdf4::nc_open(file_path)
```

Let's tery using the code we imported from Sean Raffuse

```{r raffuse_code}
df <- extract_aod(file_path)
dim(df)
names(df)
```

Let's try plotting point locations:

```{r point_locations}
sub <- sample_n(df, 5e4)
plot(sub$lon, sub$lat, pch='.')
data(SimpleCountries)
plot(SimpleCountries, add = TRUE, border = 'red')
```

So far so good! Let's subset for Texas:

```{r texas}
loadSpatialData('USCensusStates')
Texas <- subset(USCensusStates, stateCode == "TX")
bb_tx <- bbox(Texas)
# Subset the data
df_tx <-
  df %>%
  filter(lon >= bb_tx['x','min']) %>%
  filter(lon <= bb_tx['x','max']) %>%
  filter(lat >= bb_tx['y','min']) %>%
  filter(lat <= bb_tx['y','max'])
# Now plot all of the points  
plot(df_tx$lon, df_tx$lat, type = 'p', pch='.')
# We can also add counties from the maps package
library(maps)
map('county', 'texas', add = TRUE, col = "dodgerblue")
# Put the USCensusStates outline on top
plot(Texas, add = TRUE, border = "red")
```

That's all fine and dandy but my understanding of a raster is that it is a 
rectangular grid of adjacent pixels. So we need to work with the full dataset
from the netcdf file.

Let's try some of the other functions stolen from Sean Raffuse:

```{r goes_getCoordGrid}
# Get AOD (ncvar_get applies scaling factor)
aod <- ncvar_get(nc, "AOD")
dim(aod)

# Don't want to hear the whining about "NaNs produced"
suppressWarnings({
  goes_grid <- goes_getCoordGrid(nc)
})

dim(goes_grid)

# goes_grid has "unraveled" the grid
nrow(aod) * ncol(aod)
```

Can we "re-ravel"? Got to be careful with `byrow`! Try it with `TRUE`

```{r ravel_byrow_true}
lon <- matrix(goes_grid$lon, nrow = 2500, ncol = 1500, byrow = TRUE)
lat <- matrix(goes_grid$lat, nrow = 2500, ncol = 1500, byrow = TRUE)
# pick some points in the middle to avoid ugliness in one of the corners
# using terrain.colors so I know what is low and high (green is low)
image(lon[1000:1500,1000:1500], col=terrain.colors(11))
```

That looks bad! Try `byrow = FALSE`

```{r ravel_byrow_false}
lon <- matrix(goes_grid$lon, nrow = 2500, ncol = 1500, byrow = FALSE)
lat <- matrix(goes_grid$lat, nrow = 2500, ncol = 1500, byrow = FALSE)
image(lon[1000:1500,1000:1500], col=terrain.colors(11))
```

Much better! longitude progressing from left to right if I understand the color scale properly. And latitude?

```{r lat_plot}
image(lat[1000:1500,1000:1500], col=terrain.colors(11))
```

Nice but perhaps upside down? But, then the aod might also be upside down.

```{r aod_plot}
image(aod[1000:1500,1000:1500], col=terrain.colors(11))
```

Yes, it looks like it is. So now that we strongly suspect that things are in 
the same order, we can subset and then use `as.numeric()` to unravel these
matrices to create vectors:

```{r unravel_again}
vector_lon <- as.numeric(lon[800:1000, 600:800])
vector_lat <- as.numeric(lat[800:1000, 600:800])
vector_aod <- as.numeric(aod[800:1000, 600:800])

# And of course we need to plot them to see where they are
map('state', col = 'red')
points(vector_lon, vector_lat, pch='.')

# What is the range of aod?
hist(vector_aod, n = 50)

# Set up some fake colors

color_indices <- round(vector_aod * 3)
color_indices[color_indices < 1] <- 1
vector_col <- topo.colors(7)[color_indices]
map('county', c('texas','louisiana'), col = 'black')
points(vector_lon, vector_lat, col = vector_col, pch=18, cex=0.2)
```


Compared with our earlier texas map this looks correct. Yay!

The next task will be to rasterize this chunk of data as described here:

http://geog.uoregon.edu/bartlein/courses/geog490/week06-geospatial.html#gridding-or-rasterizing-point-data

Good Luck!
