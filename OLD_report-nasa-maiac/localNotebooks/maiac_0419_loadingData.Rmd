---
title: "Reading MAIAC data"
output: html_document
params:
  maiacFilePath: "~/Data/maiac/MAIACAAOT.h01v04.20172822150.nc"
  spatialDataDir: "~/Data/Spatial"
---

<!-- 
To knit: download the MAIAC file from Oct 10, 2017, and convert it to .nc. 
This can be done by running the following R code:
# note: maiacDataDir should be the directory where you keep maiac data eg. "~/Data/maiac"
# The converter for converting hdf to ncdf is located at executables/h4toncff_nc4
hdffilePath <- maiac_downloadNorthAmerica("h01v04", 20171010, 1915, product = "MAIACTAOT",  maiacDataDir = maiacDataDir)
nc4filePath <- maiac_2nc4(hdffilePath)
nc4filePath
Then set the knitr parameter 'maiacFilePath' to nc4filePath (the location of the .nc file)
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
maiacFilePath <- params$maiacFilePath
spatialDataDir <- params$spatialDataDir
```

This notebook documents the process and challenges of loading MAIAC data

```{r packages}
library(PWFSLSmoke)
library(PWFSLSmokeModeling)
setSpatialDataDir(spatialDataDir)
loadSpatialData("USCensusStates")
source("../R/maiac_convertGridToRaster.R")
```

We are interested in looking at smoke from northern California fires during the large set of fires in October. Let's load October 10. Maiac files are datestamped based on the Julian calendar day, which would be 282. We are interested in the variable 'Optical_Depth_055'. We can also load the latitude and longitude values, which may come in handy.

```{r load}
file <- ncdf4::nc_open(maiacFilePath)
latitude <- ncdf4::ncvar_get(file, 'grid1km_latitude')
longitude <- ncdf4::ncvar_get(file, 'grid1km_longitude')
aot <- ncdf4::ncvar_get(file, 'Optical_Depth_055')
```

The MAIAC file is gridded data. The best way to represent it in R would probably be as a Raster object (using the `raster` package). To do that, we would have to figure out the appropriate projection to assign. This metadata (an exerpt of the lengthy output from `print(file)`) may come in handy:

```{}
GROUP=GRID_1
		GridName="grid1km"
		XDim=1200
		YDim=1200
		UpperLeftPointMtrs=(-2800000.000000,2400000.000000)
		LowerRightMtrs=(-1600000.000000,1200000.000000)
		Projection=GCTP_ALBERS
		ProjParams=(0,0,20000000,60000000,-96000000,23000000,0,0,0,0,0,0,0)
		SphereCode=12
		GridOrigin=HDFE_GD_UL
		GROUP=Dimension
		END_GROUP=Dimension
```

NASA has [some information online](https://modis-land.gsfc.nasa.gov/MODLAND_grid.html) about the projection it uses. It turns out that the projection is sinusoidal. More specifications and the proj4 parameters can be found [here](http://spatialreference.org/ref/sr-org/modis-sinusoidal/). How convenient!

Also, when assigning values, if we assign a vector, and values are assigned starting from the upper left, and then left to right and top to bottom. 

So, based on the information in the metadata and projection documentation, this is what I expect the raster should look like (trying with transposed values because I'm not sure which way is correct...):

```{r makeRaster}
aot_raster <- raster::raster(nrows = 1200, ncols = 1200, 
                             xmn = -2800000.000000, xmx = -1600000.000000,
                             ymn = 1200000.000000, ymx = 2400000.000000,
                             crs = CRS("+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +a=6371007.181 +b=6371007.181 +units=m +no_defs "),
                             vals = aot)
plot(aot_raster)
aot_raster_transposed <- raster::raster(nrows = 1200, ncols = 1200, 
                             xmn = -2800000.000000, xmx = -1600000.000000,
                             ymn = 1200000.000000, ymx = 2400000.000000,
                             crs = CRS("+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +a=6371007.181 +b=6371007.181 +units=m +no_defs "),
                             vals = t(aot))
plot(aot_raster_transposed)
```

In the transposed version you can kind of follow what might be the California coastline in the white border. I'm not sure if it makes sense that there would be generally higher values over water than land though. 

Let's try transforming it to a more normal crs and plotting some state borders over the top. 

```{r trasforming, cache = TRUE}
aot_raster_latlong <- raster::projectRaster(aot_raster_transposed, crs = CRS("+init=epsg:3310"))
plot(aot_raster_latlong)
```
This is not the expected output. The latitude and longitude values are obviously incorrect for California, and the shape didn't change to something more recognizable. Obviously there was some mistake in the extent or projection coordinates. Let's try something different. 

Since we have the lat/lon coordinates, let's use those to stick these values in a grid using `raster::rasterize()`. A 1km grid for the whole extent is too big -- it crashes R. So let's try a 5km grid, to see what happens.

```{r latlng, cache = TRUE}
aot_raster_latlong <- raster::raster(nrows = 1200, ncols = 1200, 
                             xmn = min(longitude), xmx=max(longitude),
                             ymn = min(latitude), ymx=max(latitude),
                             crs = CRS("+init=epsg:3310"))
mc_raster <- raster::rasterize(x = data_frame(as.numeric(longitude), latitude=as.numeric(latitude)), y = aot_raster_latlong, field = as.numeric(aot), fun = mean, na.rm=TRUE)
plot(mc_raster, col = colorRampPalette(c("white", "orange", "red"))(255))
plot(USCensusStates, add = TRUE)
```

it is pretty succesful! 

Let's try cropping to the extent we want and plot next to some model and monitoring data.

```{r}
fires_maiac <- raster::crop(mc_raster, raster::extent(-125.52, -117.03, 36.52, 41.78))
plot(fires_maiac, col = colorRampPalette(c("white", "orange", "red"))(255))
plot(USCensusStates, add = TRUE)
```


Load Monitor data for 10/10, using the snapshot of hour 21 (?)

```{r, cache = TRUE}
airnow <- airnow_load(2017)
wrcc <- wrcc_load(2017)
airsis <- airsis_load(2017)
ws_monitor <- monitor_combine(list(airnow, wrcc, airsis))
monitorMap(ws_monitor)
fire_monitors <- monitor_subset(ws_monitor, stateCodes = "CA", tlim = c(2017101000, 2017101023))
plot(fires_maiac, col = colorRampPalette(c("white", "orange", "red"))(255), main = "MAIAC data and monitoring data 10/10/2017")
plot(USCensusStates, add = TRUE)
monitorMap(fire_monitors, add = TRUE)
```

```{r, cache = TRUE}
bs <- bluesky_load(model = 'NAM-3km', modelRun = 2017101000, file = "/Users/helen/Data/Bluesky/NAM-3km_2017101012.nc")
fire_bs_grid <- grid_subset(bs, xlim = c(-125.52, -117.03), ylim = c(36.52, 41.78))
fire_bs <- convertGridToRaster(fire_bs_grid)
plot(fire_bs[[9]], col = colorRampPalette(c("white", "orange", "red"))(255), main = "Bluesky data and monitoring data 10/10/2017")
monitorMap(fire_monitors, add = TRUE)
plot(USCensusStates, add = TRUE)
```
