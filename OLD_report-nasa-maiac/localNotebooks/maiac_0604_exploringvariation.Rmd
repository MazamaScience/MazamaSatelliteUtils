---
title: "Variation in Satellite vs Monitoring Data"
author: "Helen Miller"
date: "6/4/2018"
output: html_document
params:
  baseDir: '~/Projects/airfire-nasa-maiac'
  spatialDataDir: '~/Data/Spatial'
  maiacDataDir: '~/Data/maiac'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
baseDir <- params$baseDir
spatialDataDir <- params$spatialDataDir
maiacDataDir <- params$maiacDataDir
library(AirfireNasaMaiac)
library(PWFSLSmoke)
library(PWFSLSmokeModeling)
library(raster)
logger.setup()
setSpatialDataDir(spatialDataDir)
setMaiacDataDir(maiacDataDir)
loadSpatialData("USCensusStates")
library(lubridate)
# aeaStates <- spTransform(USCensusStates, CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84"))
```

The goal of this notebook is to follow several locations throughout a wildfire season and see how satellite vs monitoring data compares or those particular locations, and whether results vary between locations. Since we are focusing on Northern California, this analysis will only include locatoins within the 
h01v04 MAIAC tile. Five monitors within that extent are randomly chosen. The monitoring values and satellite values are compared for every 10 days from May 01 to Nov 01, every day October 08-14 (during the Napa Valley fires), and every day from June 01-07 when there were no major fires.

```{r get_monitoring_data}
airnow <- airnow_load(2017)
wrcc <- wrcc_load(2017)
airsis <- airsis_load(2017)
mon <- monitor_combine(list(airnow, wrcc, airsis))
oct09 <- maiac_loadRaster("h01v04", 20171009, 2150, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
ca <- monitor_subset(mon, xlim = c(xmin(oct09), -114.5), ylim = c(ymin(oct09), 41))
sampleIds <- c("060374004_01", "060798002_01", "060950004_01", "060271003_01", "060110007_01")
sample <- monitor_subset(ca, monitorIDs = sampleIds)
octids <- c("060550003_01", "lon_.122.267_lat_38.220_arb2.1023", "lon_.122.133_lat_38.211_arb2.1034",
            "060950004_01","060131004_01", "060010013_01")
octsample <- monitor_subset(ca, monitorIDs = octids)
plot(oct09)
plot(USCensusStates, add = TRUE)
monitorMap(sample, add = TRUE)
```


```{r get_maiac_data, warning=FALSE, message=FALSE, cache=TRUE}
first <- ymd(20170501)
last <- ymd(20171101)
seqdays <- seq(first, last, '10 days')
junedays <- seq(ymd(20170501), ymd(20170510), 'days')
octdays <- seq(ymd(20171008), ymd(20171018), 'days')
days <- c(seqdays, junedays, octdays)

may01 <- maiac_loadRaster("h01v04", 20170501, 2105, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
may11 <- maiac_loadRaster("h01v04", 20170511, 2140, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
may21 <- maiac_loadRaster("h01v04", 20170521, 2040, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
may31 <- maiac_loadRaster("h01v04", 20170531, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
jun10 <- maiac_loadRaster("h01v04", 20170610, 2155, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
jun20 <- maiac_loadRaster("h01v04", 20170620, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
jun30 <- maiac_loadRaster("h01v04", 20170630, 2130, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
jul10 <- maiac_loadRaster("h01v04", 20170710, 2030, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
jul20 <- maiac_loadRaster("h01v04", 20170720, 2105, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
jul30 <- maiac_loadRaster("h01v04", 20170730, 2140, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
aug09 <- maiac_loadRaster("h01v04", 20170809, 2040, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
aug19 <- maiac_loadRaster("h01v04", 20170819, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
aug29 <- maiac_loadRaster("h01v04", 20170829, 2155, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
sep08 <- maiac_loadRaster("h01v04", 20170908, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
sep18 <- maiac_loadRaster("h01v04", 20170918, 2130, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
sep28 <- maiac_loadRaster("h01v04", 20170928, 2030, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
oct08 <- maiac_loadRaster("h01v04", 20171008, 2105, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
oct18 <- maiac_loadRaster("h01v04", 20171018, 2140, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
oct28 <- maiac_loadRaster("h01v04", 20171028, 2040, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
seqdata <- list(may01=may01, may11=may11, may21=may21, may31=may31, jun10=jun10, jun20=jun20, jun30=jun30, jul10=jul10, jul20=jul20, jul30=jul30, aug09=aug09, aug19=aug19, aug29=aug29, sep08=sep08, sep18=sep18, sep28=sep28, oct08=oct08, oct18=oct18, oct28=oct28)


oct09 <- maiac_loadRaster("h01v04", 20171009, 2150, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
oct10 <- maiac_loadRaster("h01v04", 20171010, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
oct11 <- maiac_loadRaster("h01v04", 20171011, 2135, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
oct12 <- maiac_loadRaster("h01v04", 20171012, 2040, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
oct13 <- maiac_loadRaster("h01v04", 20171013, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
oct14 <- maiac_loadRaster("h01v04", 20171014, 2030, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
octdata <- list(oct08=oct08, oct09=oct09, oct10=oct10, oct11=oct11, oct12=oct12, oct13=oct13, oct14=oct14
                )
# jun01 <- maiac_loadRaster("h01v04", 20170601, product = "MAIACTAOT", converterPath = "../executables/h4toncff_nc4") %>%
#    projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"))
# jun02 <- maiac_loadRaster("h01v04", 20170602, 2105, converterPath = "../executables/h4toncff_nc4") %>%
#   projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
# jun03 <- maiac_loadRaster("h01v04", 20170603, 2150, converterPath = "../executables/h4toncff_nc4") %>%
#   projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
# jun04 <- maiac_loadRaster("h01v04", 20170604, converterPath = "../executables/h4toncff_nc4") %>%
#   projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
# jun05 <- maiac_loadRaster("h01v04", 20170605, 2135, converterPath = "../executables/h4toncff_nc4") %>%
#   projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
# jun06 <- maiac_loadRaster("h01v04", 20170606, 2040, converterPath = "../executables/h4toncff_nc4") %>%
#   projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
# jun07 <- maiac_loadRaster("h01v04", 20170607, converterPath = "../executables/h4toncff_nc4") %>%
#   projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) 
# jundata <- list(jun01=jun01, jun02=jun02, jun03=jun03, jun04=jun04, jun05=jun05, jun06=jun06, jun07=jun07)

```

```{r create_datasets}
getValue <- function(raster, x, y) {
  value <- raster::getValues(raster)[raster::cellFromXY(raster, c(x, y))]
  return(value)
}
hour(seqdays) <- 21
satellite <- tibble(date=as.POSIXct(seqdays))
for(id in sampleIds) {
  satellite[id] <- numeric()
}
for(i in 1:length(seqdata)) {
  for (id in sampleIds) {
    satellite[i, id] <- getValue(seqdata[[i]], ca$meta[id, "longitude"], ca$meta[id, "latitude"])
  }  
}
satellite

monitor <- tibble(date=as.POSIXct(seqdays))
for( id in sampleIds ) {
  monitor[id] <- numeric()
  for(i in 1:length(seqdata)) {
  monitor[i, id] <- sample$data[[id]][which(sample$data$datetime == seqdays[i])]
  }

}


hour(octdays) <- 21
octsatellite <- tibble(date=as.POSIXct(octdays))
for(id in octids) {
  octsatellite[id] <- numeric()
}
for(i in 1:length(octdata)) {
  for (id in octids) {
    octsatellite[i, id] <- getValue(octdata[[i]], ca$meta[id, "longitude"], ca$meta[id, "latitude"])
  }  
}

octmonitor <- tibble(date=as.POSIXct(octdays))
for( id in octids ) {
  octmonitor[id] <- numeric()
  for(i in 1:length(octdata)) {
    octmonitor[i, id] <- octsample$data[[id]][which(octsample$data$datetime == octdays[i])]
  }
}



```


## Data from every 10 days

```{r}
par(mar = c(5,5,2,5))
for(id in sampleIds) {
  plot(monitor$date, monitor[[id]], type = "l", lty = 1, xlab = "date", ylab = "PM25", main = id)
  par(new = TRUE)
  plot(satellite$date, satellite[[id]], type = "l", lty = 2, axes=F, xlab=NA, ylab=NA)
  axis(side = 4)
  mtext(side = 4, line = 3, 'AOT')
  plot(monitor[[id]], satellite[[id]], main = id)
}
```

## Data from October 8-14
```{r}
for(id in octids) {
  plot(octmonitor$date, octmonitor[[id]], type = "l", lty = 1, xlab = "date", ylab = "PM25", main = id)
  par(new = TRUE)
  plot(octsatellite$date, octsatellite[[id]], type = "l", lty = 2, axes=F, xlab=NA, ylab=NA)
  axis(side = 4)
  mtext(side = 4, line = 3, 'AOT')
  plot(octmonitor[[id]], octsatellite[[id]], main = id)
}
```




