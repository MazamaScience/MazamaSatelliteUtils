---
title: "Exploring satellite data"
output: html_document
params:
  maiacDataDir: "~/Data/maiac"
  spatialDataDir: "~/Data/Spatial"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
baseDir <- '~/Projects/airfire-nasa-maiac'
library(AirfireNasaMaiac)
library(PWFSLSmoke)
library(PWFSLSmokeModeling)
library(raster)
logger.setup()

# Pull out params
maiacDataDir <- params$maiacDataDir
spatialDataDir <- params$spatialDataDir


setMaiacDataDir(maiacDataDir)
setSpatialDataDir(spatialDataDir)
loadSpatialData("USCensusStates")
# aeaStates <- spTransform(USCensusStates, CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84"))
```

# Load some data
## MAIAC data from AQUA satellite

`maiac_loadRaster()` first calls `maiac_downloadNorthAmerica()` to find the requested file -- if found locally, the local version is loaded -- if not, the file is downloaded. 

Then, it calls `maiac_2nc4()` to convert the HDF file into a netcdf file. If the .nc file already exists locally, it is loaded.

Metadata about the projection and extent is loaded using `maiac_getMetadata()`. This information is used to load the netcdf data into a raster object using the `raster` package.

Currently, `maiac_loadRaster()` always creates the raster object with the same default projection. It should be possible to build the proj4 string to define the projection based on the metadata, or allow the user to specify the proper projection which would allow for loading data with a different projection. 

The projection information used in this function is (as a proj4 string): `+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84`
This is based on information found in the [HDF-EOS Library Users Guide](https://newsroom.gsfc.nasa.gov/sdptoolkit/docs/HDF-EOS_REF.pdf) and the file metadata. 

```{r loadingData, message=FALSE}
oct08 <- maiac_loadRaster("h01v04", 20171008, 2105, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct09 <- maiac_loadRaster("h01v04", 20171009, 2150, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct10 <- maiac_loadRaster("h01v04", 20171010, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct11 <- maiac_loadRaster("h01v04", 20171011, 2135, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct12 <- maiac_loadRaster("h01v04", 20171012, 2040, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct13 <- maiac_loadRaster("h01v04", 20171013, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
```

## Monitoring Data

Load some monitoring data for comparison

```{r loadingMonitoringData}
airnow <- airnow_load(2017)
wrcc <- wrcc_load(2017)
airsis <- airsis_load(2017)
mon <- monitor_combine(list(airnow, wrcc, airsis))
canv <- monitor_subset(mon, tlim = c(20171008, 20171016), xlim = c(-125.52, -117.03), ylim = c(36.52, 41.78))
```

# Plot Satellite and monitoring data

These plots overlay monitoring sites on top of the satellite data, colored by AOT. Monitors are colored by AQI colors based on the maximum value between 20:00 and 23:00 UTC on the day specified. All MAIAC files were timestamped between 20:00 and 22:00. I assume that represents the time the data was collected. 

```{r plottingData}
colors <- colorRampPalette(c("white", "orange", "red"))(9)
breaks <- c(0, 0.03, 0.1, 0.2, 0.3, 0.5, 0.8, 3)
rasterList <- list(oct08, oct09, oct10, oct11, oct12, oct13)
for ( i in 1:6 ) {
  raster <- rasterList[[i]]
  day <- stringr::str_pad(i+7, 2, "left", "0")
  plot(raster, breaks = breaks, col = colors, colNA = "gray90", alpha = .8, main = paste0("Oct ", day))
  plot(USCensusStates, add = TRUE)
  monitor_subset(canv, tlim = paste0("201710", day, c("20", "23")) ) %>% 
    monitorMap(add = TRUE)
}
```

We can definitely see the smoke from the fires. The first fire ignited the evening of October 8, which would have been after October 8 satellite swath, so Oct 8 shows low values all around for both AOT and ground-level PM2.5. The picture is very different for October 10, with high AOT values in the Napa Valley, which appear to represent large clouds of smoke. Monitoring data follows a similar pattern. Unfortunately, there is a lot of missing data in the area of interest for October 10 and 11, possibly due to cloud cover, but where there is satellite data we can see that there are high AOT values near the Bay Area. So far, this is only AQUA data. We may be able to fill in some gaps by looking at TERRA data. On October 12 and 13, we get a fuller picture again. 

In general, visually, monitoring data seems to correlate pretty closely with satellite data. It is not perfect, and the discrete color scale that the monitors are plotted in may obscure some patterns. Let's take a look at how the numbers line up. 

# Relationship between monitoring and satellite values

Let's look at Oct 12 because the satellite data has little missing data and a good range of values.
Build a dataset of monitoring values at Oct 12, 2017 21:00 vs satellite values at those points

```{r buildComparison}
getValue <- function(raster, x, y) {
  value <- raster::getValues(raster)[raster::cellFromXY(raster, c(x, y))]
  return(value)
}
monitorCount <- nrow(canv$meta)
df <- data_frame(monitorID = canv$meta$monitorID, 
                 monitor = vector("numeric", monitorCount),
                 satellite = vector("numeric", monitorCount))

timeIndex <- which(canv$data$datetime == lubridate::ymd_h("2017101221"))
for (i in 1:monitorCount) {
  monitorInfo <- canv$meta[i,]
  df[i,'monitor'] <- canv$data[timeIndex, monitorInfo$monitorID]
  df[i, 'satellite'] <- getValue(oct12, monitorInfo$longitude, monitorInfo$latitude)
}

plot(df$monitor, df$satellite, main = "Oct 12 21:00 UTC", xlab = "monitoring data (PM2.5 ug/m3)", ylab = "satellite data (AOT)")
abline(lm(df$satellite~df$monitor))
```

This is a pretty encouraging plot. Monitoring and satellite data appear to be pretty well-correlated. For more similar plots from other days, see the .Rmd file. 

There are also a lot of missing monitoring values at that hour. Let's see if there is any pattern. 

```{r}
hist(df$satellite[which(is.na(df$monitor))], 25, xlim = c(0,1.2), main = "Satellite values where monitor has missing value", xlab = "AOT")
hist(df$satellite, 50, xlim = c(0,1.2), main = "Satellite values at all monitoring sites", xlab = "AOT")
hist(getValues(oct12), 100, main = "All satellite values", xlim = c(0, 1.2), xlab = "AOT")
```

There doesn't seem to be any pattern. Based solely on the histograms, it seems plausible that the monitoring sites are pretty representative of all of the area, and that missing values are not related to air quality. 

Let's look at the monitoring vs satellite values for some other days. Oct 8, Oct 9, and Oct 13 might be good to add to the dataset. 

Oct 8

```{r buildComparison08}
dfo8 <- data_frame(monitorID = canv$meta$monitorID, 
                 monitor = vector("numeric", monitorCount),
                 satellite = vector("numeric", monitorCount))

timeIndexo8 <- which(canv$data$datetime == lubridate::ymd_h("2017100821"))
for (i in 1:monitorCount) {
  monitorInfo <- canv$meta[i,]
  dfo8[i,'monitor'] <- canv$data[timeIndexo8, monitorInfo$monitorID]
  dfo8[i, 'satellite'] <- getValue(oct08, monitorInfo$longitude, monitorInfo$latitude)
}

plot(dfo8$monitor, dfo8$satellite, main = "Oct 08 21:00 UTC", xlab = "monitoring data (PM25)", ylab = "satellite data (AOT)")
```

Oct 9

```{r buildComparison09}
dfo9 <- data_frame(monitorID = canv$meta$monitorID, 
                 monitor = vector("numeric", monitorCount),
                 satellite = vector("numeric", monitorCount))

timeIndexo9 <- which(canv$data$datetime == lubridate::ymd_h("2017100921"))
for (i in 1:monitorCount) {
  monitorInfo <- canv$meta[i,]
  dfo9[i,'monitor'] <- canv$data[timeIndexo9, monitorInfo$monitorID]
  dfo9[i, 'satellite'] <- getValue(oct09, monitorInfo$longitude, monitorInfo$latitude)
}

plot(dfo9$monitor, dfo9$satellite, main = "Oct 09 21:00 UTC", xlab = "monitoring data (PM25)", ylab = "satellite data (AOT)")
```

Oct 13

```{r buildComparison13}
dfo13 <- data_frame(monitorID = canv$meta$monitorID, 
                 monitor = vector("numeric", monitorCount),
                 satellite = vector("numeric", monitorCount))

timeIndexo13 <- which(canv$data$datetime == lubridate::ymd_h("2017101321"))
for (i in 1:monitorCount) {
  monitorInfo <- canv$meta[i,] 
  dfo13[i,'monitor'] <- canv$data[timeIndexo9, monitorInfo$monitorID]
  dfo13[i, 'satellite'] <- getValue(oct13, monitorInfo$longitude, monitorInfo$latitude)
}

plot(dfo13$monitor, dfo13$satellite, main = "Oct 13 21:00 UTC", xlab = "monitoring data (PM25)", ylab = "satellite data (AOT)")
```

Now let's look at all four of those days aggregated. 

```{r buildComparisonAll}
combinedValues <- add_row(df, satellite = dfo8$satellite, monitor = dfo8$monitor) %>%
  add_row(satellite = dfo9$satellite, monitor = dfo9$monitor) %>%
  add_row(satellite = dfo13$satellite, monitor = dfo13$monitor)

plot(combinedValues$monitor, combinedValues$satellite,  main = "Oct 8-13 21:00 UTC", xlab = "monitoring data (PM25)", ylab = "satellite data (AOT)")
```


# Look at the data distributions
```{r plotDataDistribution}
par(mfcol = c(1,2))
hist(getValues(oct08), 500, main = "Oct08")
hist(log(getValues(oct08)), 500, main = "Oct08 (log)", ylim = c(0,5000))
hist(getValues(oct09), 500, main = "Oct09")
hist(log(getValues(oct09)), 500, main = "Oct09 (log)", ylim = c(0,5000))
hist(getValues(oct10), 500, main = "Oct10")
hist(log(getValues(oct10)), 500, main = "Oct10 (log)", ylim = c(0,5000))
hist(getValues(oct11), 500, main = "Oct11")
hist(log(getValues(oct11)), 500, main = "Oct11 (log)", ylim = c(0,5000))
hist(getValues(oct12), 500, main = "Oct12")
hist(log(getValues(oct12)), 500, main = "Oct12 (log)", ylim = c(0,5000))
hist(getValues(oct13), 500, main = "Oct13")
hist(log(getValues(oct13)), 500, main = "Oct13 (log)", ylim = c(0,5000))
```

There is a significant amount of variability between different days. For most days, taking the log of the values tends to normalize the distribution pretty well. Just Oct 8 and Oct 9 have a peak at 0, which disappears in subsequent days. Many days seem to have multiple peaks. This could indicate that there are two distributions of values: the normal baseline, and values over a wildfire. 