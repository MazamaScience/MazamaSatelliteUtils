---
title: "Exploration - Sand Fire"
output:
  html_document: default
---

```{r, echo=FALSE}
knitr::opts_chunk$set(fig.width=8)
```

This notebook documents the data exploration process of trying to find a story in the data. It begins with just getting a better handle on the data. We then hope to expand to make intercomparisons between the data to tell a story.

## Setup and Data Import

Per the `dataSetup` exploration, we simply need to run one line of code now to get the data we need for exploring the data:

```{r setup, message=FALSE}
baseDir <- '~/Projects/Mazama/airfire-nasa-maiac/'
source(paste0(baseDir, 'R/createSandFiresData.R'))
```

OK, so now we have the following in memory, among other things:

* **Bluesky aggregate**: 2-km CANSAC-based model output, with data aggregated from runs 2016072112 to 20160726. We have saved this in the following formats:
    + ws_grid (`ws_grid_2km`)
    + ws_raster (`ws_raster_2km`) -- a rasterBrick

* **MAIAC swath**: lat/lon/AOT data from the 7/21/16 pass(es) of the AQUA satellite. We have saved this in the following formats:
    + dataframe (`maiac`)
    + rasterLayer, on CANSAC 2-km grid (`maiacGrid`)

* **Monitor Data**: EPA monitor data from 20160721 to 20160727, from EPA codes 88101 and 88502. This has been saved as a single `ws_monitor` object.

Here's plots to show where we're at:

```{r echo=FALSE}
par(mfrow=c(1,2))
# bluesky data (a single slice of 3D rasterBrick)
plot(ws_raster_2km[[40]], col=colors_bs, breaks=breaks_bs, legend=FALSE, main="bluesky slice (as raster)\nw/ EPA monitors")
map(database="state", add=TRUE)
monitorMap(Sand_monitors, add=TRUE)

# MAIAC swath (as raster)
plot(maiacGrid, col=colors_maiac, breaks=breaks_maiac, main="MAIAC swath (as raster)\nw/ EPA monitors")
map(database="state", add=TRUE)
monitorMap(Sand_monitors, add=TRUE)
```

A little more about the data before we jump into exploration around the Sand fire.

### MAIAC Swath Data

https://ladsweb.modaps.eosdis.nasa.gov/api/v1/productGroupPage/name=maiac

MAIAC is an output from the MODIS instrument, and as such, is only available for discrete periods corresponding to when the satellite passed overhead. In other words, we don't really have evenly-spaced time-series data at specific points like we do for monitors or Bluesky model output.

We received one sample file from Susan, supposedly from the 7/21/16 passover by the AQUA satellite. The Aqua satellite is part of the A-Train, which traverses the globe (on the day side) from SSE to NNW, crossing the equator (NNW-bound) at ~1:30 pm solar time. So, the initial assumption was that the data file corresponded to one of these passes, around 1pm local time.

However, after a little digging, it looks like the "swath" data we received may actually be from TWO separate passes of the AQUA satellite. See the following image, which shows the path of the satellite on 7/21/16.

![AQUA Paths 7/21/16](https://www.ssec.wisc.edu/datacenter/aqua/GLOBAL2016_07_21_203_aqua.gif)

As shown, based on the ascending tracks (i.e. the tracks that go from bottom right to top left, which is the only time the instrument returns observations), the satellite passed on either side of Southern California at approximately ~20:40 and ~22:20 (UTC, presumably). This revelation helps us make sense of an interesting pattern in the "swath" data we saw before. If you look at the "swath" data above, you will notice that most of the landmass is covered, but most of the ocean surface empty -- except for west and south of a strange sharp line that traverses the map from the far NW corner SSE towards the bottom of the map.

I thought this pattern was strange at first, but didn't put much thought into it since it is over water, while we're mostly interested with the air quality over land. However, this pattern seems to jive with what we see in the map showing AQUA passover times. Thus, it would appear that most of the data over land probably came from the first pass of AQUA around 20:40 UTC, while the rest of the data over water probably came from the second pass of AQUA around 22:20 UTC.

Now, of course we probably aren't too concerned with air quality over the ocean. However, if true, this is an important realization as it means that the MAIAC data may not reprsent a single snapshot in time as we previously thought. For each "swath" file we receive, we will want to know how many satellite passes went into it, at what time(s) the data was recorded, and how the data was handled in cases where a single location may have received more than one reading.

On that note, I was curious to see if we might be able to tell any of this from the data we already had. Seeing as the MAIAC data we recieved came in as a simple dataframe with latitude, longitude and AOT, I thought that perhaps we would see a higher density of points where two swaths covered the same area. I had looked at density in a previous exploration, but I hadn't looked at the whole area. Perhaps I'd missed an important observation? Let's check it out:

```{r}
color_counts <- RColorBrewer::brewer.pal(6, "GnBu")

# let's see how many points per cell...
maiacGrid_counts <- convertSwathToRaster(maiac, ws_raster_2km, fun='count')
plot(maiacGrid_counts, col=color_counts, main="MAIAC observations per Bluesky grid cell")
map(database="state", add=TRUE)
```

What we see here is a relatively consistent density across the entire geographic range of the data. Or, said another way, we DON'T see higher density where we would expect to if the points were simply reported as they were observed (i.e. the top left corner). So it appears this data was somehow "flattened" from raw swath form to some grid prior to distribution.

OK, so that's a lot about the MAIAC swath data. But in any case, importantly, this was an entire day before the Sand fire was first reported. So the swath data represents conditions at two time periods, both of which were prior to impacts from the fire (though there were other fires in the region at the time).



### Bluesky Data

The bluesky data represents an aggregation of model output from several different model runs. We started with the 2016072112 (UTC) run; the data for this model run (and all runs) actually begins the hour after model initialization, so 2016-07-21 Hr 13 (UTC) in this case.

We used `chunk=1` to aggregate so we only use the first 12 hrs from each model (unless one is missing, in which case we use the prior run). Thus, we use the following models for the following time periods:

* 2016072112 model run: for 2016-07-21 Hr 13 through 2016-07-22 Hr 00
* 2016072200 model run: for 2016-07-22 Hr 01 through 2016-07-22 Hr 12
* 2016072212 model run: for 2016-07-22 Hr 13 through 2016-07-23 Hr 00
* 2016072300 model run: for 2016-07-23 Hr 01 through 2016-07-23 Hr 12

... and so on ...

SO -- if we want to look at data corresponding to our MAIAC "swath" data, we only have one model we can pull from in the current data: 201607212. So we can use our existing ws_grid (or corresponding ws_raster) object. To add additional model runs we'd need to go back in time to previous runs. But since we have one model that covers the period of the TWO MAIAC passes, we can compare these two data sources to look for similarities.

### Exploration

So, now that we have our data in hand, and understand it a bit more, let's start some exploring!

Our ultimate goal will be to explore ground and MAIAC observations as well as bluesky model output for periods surrounding the Sand fire which took place in southern California in late July 2016. Per Wikipedia and InciWeb, this fire was first reported the afternoon of July 22, 2016. But again, our only MAIAC data thus far is from prior to the start of this fire, on 7/21/16. So we'll just look at model vs. MAIAC for now to see if we can find any similarities.

Let's look again at our MAIAC swath.

```{r}
# MAIAC swath (as raster)
plot(maiacGrid, col=colors_maiac, breaks=breaks_maiac, main="MAIAC swath (as raster)")
map(database="state", add=TRUE)
```

Again, this swath most likely represents a composite of two passes of the AQUA satellite, at 20:40 and ~22:20 (UTC) on 7/21/16.

Our current bluesky data covers this period. Let's look at the first few time slots in our bluesky data to figure out which slice(s) we should compare.

```{r}
head(ws_grid_2km$time, 20)
```

Here it looks like slices 8-11 will give us model output closest to the two satellite passes.

Let's try plotting each next to the swath data to see if it looks anything like the MAIAC swath...

```{r echo=FALSE}

createSideBySide <- function(slice) {
  par(mfrow=c(1,2))
  
  time <- ws_grid_2km$time[slice]
  maxValue <- raster::maxValue(ws_raster_2km)[slice]
  
  plot(ws_raster_2km[[slice]], col=colors_bs, breaks=breaks_bs, legend=FALSE, main=paste0("bluesky slice #", slice, "\n",time))
  map(database="state", add=TRUE)
  plot(maiacGrid, col=colors_maiac, breaks=breaks_maiac, main="MAIAC swath")
  map(database="state", add=TRUE)
  layout(1)
}

```


```{r echo=FALSE}
createSideBySide(8)
```

```{r echo=FALSE}
createSideBySide(9)
```

```{r echo=FALSE}
createSideBySide(10)
```

```{r echo=FALSE}
createSideBySide(11)
```

Hmm. Not a very good match, is it?

Let's try adjusting the data to be on the same scales and see if that helps. Let's normalize the bluesky data so it'll be on the same scale as the MAIAC data (approximately 0 to 1).

...

