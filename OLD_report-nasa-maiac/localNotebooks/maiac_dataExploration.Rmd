---
title: "MAIAC data exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
baseDir <- '~/Projects/airfire-nasa-maiac'
library(PWFSLSmoke)
library(PWFSLSmokeModeling)
library(raster)
logger.setup()
source(file.path(baseDir, 'R/maiac_2nc4.R'))
source(file.path(baseDir, 'R/maiac_downloadNorthAmerica.R'))
source(file.path(baseDir, 'R/maiac_getMetadata.R'))
source(file.path(baseDir, 'R/maiac_loadRaster.R'))
setSpatialDataDir("~/Data/Spatial")
loadSpatialData("USCensusStates")
# aeaStates <- spTransform(USCensusStates, CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84"))
```

# Load some data
## MAIAC data from AQUA satellite

`maiac_loadRaster()` first calls `maiac_downloadNorthAmerica()` to find the requested file -- if found locally, the local version is loaded -- if not, the file is downloaded. 

Then, it calls `maiac_2nc4()` to convert the HDF file into a netcdf file. If the .nc file already exists locally, it is loaded.

Metadata about the projection and extent is loaded using `maiac_getMetadata()`. This information is used to load the netcdf data into a raster object using the `raster` package.

Currently, `maiac_loadRaster()` always creates the raster object with the same default projection. It should be possible to build the proj4 string to define the projection based on the metadata, or allow the user to specify the proper projection which would allow for loading data with a different projection. 

The projection information used in this function is (as a proj4 string): `+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84`
This is based on information found in the [HDF-EOS Library Users Guide](https://newsroom.gsfc.nasa.gov/sdptoolkit/docs/HDF-EOS_REF.pdf) and the file metadata. 

```{r loadingData, message=FALSE}
oct08 <- maiac_loadRaster("h01v04", 20171008, 2105, converterPath = "../executables/h4toncff_nc4") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct09 <- maiac_loadRaster("h01v04", 20171009, 2150, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct10 <- maiac_loadRaster("h01v04", 20171010, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct11 <- maiac_loadRaster("h01v04", 20171011, 2135, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct12 <- maiac_loadRaster("h01v04", 20171012, 2040, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
oct13 <- maiac_loadRaster("h01v04", 20171013, converterPath = "../executables/h4toncff_nc4") %>%
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
```

## Monitoring Data

Load some monitoring data for comparison

```{r loadingMonitoringData}
airnow <- airnow_load(2017)
wrcc <- wrcc_load(2017)
airsis <- airsis_load(2017)
mon <- monitor_combine(list(airnow, wrcc, airsis))
canv <- monitor_subset(mon, tlim = c(20171008, 20171016), xlim = c(-125.52, -117.03), ylim = c(36.52, 41.78))
```

# Plot Satellite and monitoring data

These plots overlay monitoring sites on top of the satellite data, colored by AOT. Monitors are colored by AQI colors based on the maximum value between 20:00 and 23:00 UTC on the day specified. All MAIAC files were timestamped between 20:00 and 22:00. I assume that represents the time the data was collected. 

```{r plottingData}
colors <- colorRampPalette(c("white", "orange", "red"))(9)
breaks <- c(0, 0.03, 0.1, 0.2, 0.3, 0.5, 0.8, 3)
rasterList <- list(oct08, oct09, oct10, oct11, oct12, oct13)
for ( i in 1:6 ) {
  raster <- rasterList[[i]]
  day <- stringr::str_pad(i+7, 2, "left", "0")
  plot(raster, breaks = breaks, col = colors, colNA = "gray90", alpha = .8, main = paste0("Oct ", day))
  plot(USCensusStates, add = TRUE)
  monitor_subset(canv, tlim = paste0("201710", day, c("20", "23")) ) %>% 
    monitorMap(add = TRUE)
}
```

We can definitely see the smoke from the fires. The first fire ignited the evening of October 8, which would have been after October 8 satellite swath, so Oct 8 shows low values all around for both AOT and ground-level PM2.5. The picture is very different for October 10, with high AOT values in the Napa Valley, which appear to represent large clouds of smoke. Monitoring data follows a similar pattern. Unfortunately, there is a lot of missing data in the area of interest for October 10 and 11, possibly due to cloud cover, but where there is satellite data we can see that there are high AOT values near the Bay Area. So far, this is only AQUA data. We may be able to fill in some gaps by looking at TERRA data. On October 12 and 13, we get a fuller picture again. 

In general, visually, monitoring data seems to correlate pretty closely with satellite data. It is not perfect, and the discrete color scale that the monitors are plotted in may obscure some patterns. The satellite data gives us an idea of what the smoke was like in locations lacking monitors. There is a pretty big gap in monitoring data over some of the smokiest areas, just north of the Bay Area, which suggests that there were no monitors in some of the places with the worst smoke. 
# Relationship between monitoring and satellite values

Let's take a closer look at how the numbers line up, starting with Oct 12 because the satellite data has little missing data and a good range of values.

```{r buildComparison}
getValue <- function(raster, x, y) {
  value <- raster::getValues(raster)[raster::cellFromXY(raster, c(x, y))]
  return(value)
}
monitorCount <- nrow(canv$meta)
df <- data_frame(monitorID = canv$meta$monitorID, 
                 monitor = vector("numeric", monitorCount),
                 satellite = vector("numeric", monitorCount))

timeIndex <- which(canv$data$datetime == lubridate::ymd_h("2017101221"))
for (i in 1:monitorCount) {
  monitorInfo <- canv$meta[i,]
  df[i,'monitor'] <- canv$data[timeIndex, monitorInfo$monitorID]
  df[i, 'satellite'] <- getValue(oct12, monitorInfo$longitude, monitorInfo$latitude)
}

plot(df$monitor, df$satellite, main = "Oct 12 21:00 UTC", xlab = "monitoring data (PM2.5 ug/m3)", ylab = "satellite data (AOT)")
abline(lm(df$satellite~df$monitor))
```

This is a pretty encouraging plot. Monitoring and satellite data appear to be pretty well-correlated. Let's look at a plot of the data from all 6 days. For more similar plots of other days, see maiac_0425_dataExploration.Rmd.

```{r fullComparison}
combineddf <- data_frame(monitorID = vector("character"),
                         monitor = vector("numeric"),
                         satellite = vector("numeric"))
for (i in 1:6) {
  newdf <- data_frame(monitorID = canv$meta$monitorID, 
                 monitor = vector("numeric", monitorCount),
                 satellite = vector("numeric", monitorCount))
  raster <- rasterList[[i]]
  day <- stringr::str_pad(i+7, 2, "left", "0")
  timeIndex <- which(canv$data$datetime == lubridate::ymd_h(paste0("201710", day, "21")) )
  for (i in 1:monitorCount) {
    monitorInfo <- canv$meta[i,]
    newdf[i,'monitor'] <- canv$data[timeIndex, monitorInfo$monitorID]
    newdf[i, 'satellite'] <- getValue(raster, monitorInfo$longitude, monitorInfo$latitude)
  }
  combineddf <- add_row(combineddf, satellite = newdf$satellite, monitor = newdf$monitor)
}

plot(combineddf$monitor, combineddf$satellite,  main = "Oct 8-13 21:00 UTC", xlab = "monitoring data (PM25)", ylab = "satellite data (AOT)")
abline(lm(combineddf$satellite~combineddf$monitor))
```

Even including data from days with little smoke (Oct 8) and large pieces of missing satellite data, we see a pretty strong correlation between satellite and monitoring data. Some statistical analysis could give us a better idea about how they are related. 

# Satellite data

Here, I take  a closer look at the actual values in the satellite data. In order to compare with Bluesky modeling data, we will have to understand the distribution and figure out how to normalize the two datasets. Once again, I'll start by looking at October 12. 


```{r plotDataDistribution}
par(mfcol = c(1,2))
hist(getValues(oct12), 500, main = "Oct12", xlab = "AOT")
hist(log(getValues(oct12)), 500, main = "Oct12 (log)", ylim = c(0,5000), xlab = "log(AOT)")
```

There is a significant amount of variability between different days. Taking the log of the values tends to normalize the distribution pretty well. There are two peaks. This is actually pretty common between the different days (see maiac_0425_dataExploration.Rmd for more plots). This could indicate that there are two distributions represented: the normal baseline, and values over a wildfire. 

# Conclusion and next steps

In general, these preliminary results are pretty encouraging, and open up a lot of potential avenues to explore further. Here are some next steps that I would propose:

 * Look at TERRA data. So far, I have only been exploring data from the AQUA satellite. Pulling in more data from TERRA may help fill in some gaps. The reporting time is a couple of hours off between the two satellites, which could also provide an opportunity to explore temporal patterns on a smaller scale than once every 24 hours. 
 * Explore variation between monitoring and satellite data. In general, monitoring data appears to correspond pretty well with satellite data. We could pick a few monitoring sites and look at how monitoring values relate to satellite values over many days. 
 * Start looking at Bluesky data. First, we would have to look at the distribution of values to find a way to normalize them if we have any hope of creating any sort of meaningful comparisons. 
 * Maybe look at some other MAIAC variables. I have only looked at Optical_Depth_055, but other variables might be able to help tell some other stories. 
 
 