---
title: "Exploration Setup"
output:
  html_document: default
---

```{r, echo=FALSE}
knitr::opts_chunk$set(fig.width=8)
```

This notebook documents the data exploration process of trying to find a story in the data...

## Setup and Data Import

```{r setup, message=FALSE}
library(raster)
library(PWFSLSmokeModeling)
```

```{r}
baseDir <- '~/Projects/Mazama/airfire-nasa-maiac/'
source(paste0(baseDir, 'R/convertGridToRaster.R'))
source(paste0(baseDir, 'R/convertRasterToGrid.R'))
source(paste0(baseDir, 'R/convertSwathToRaster.R'))
source(paste0(baseDir, 'R/loadRawMaiac.R'))
```

Let's load the necessary data: aggregated 2-km bluesky model runs, a single MAIAC swath, and we'll also throw in some monitor data.

```{r load_data}
load(paste0(baseDir, 'localData/Sand_bluesky_CANSAC_2km.RData'))
load(paste0(baseDir, 'localData/Sand_monitors.RData'))
maiac <- loadRawMaiac(paste0(baseDir, 'localData/maiac_sands_AQUA_20160721.nc'))
```

Let's rename the bluesky model run ws_grid object, then convert it to rasters as that's what we plan to use for analysis. We'll also get rid of the original (duplicate) object.

```{r}
ws_grid_2km <- Sand_bluesky_CANSAC_2km
ws_raster_2km <- convertGridToRaster(ws_grid_2km)
rm(Sand_bluesky_CANSAC_2km)
```

So, in memory you should now have the following:

* **maiac**: maiac swath data (data.frame w/ lat/lon/aot)
* **Sand_monitors**: monitor data
* **ws_grid_2km**: ws_grid object from 2-km CANSAC model (aggregate from multiple runs)
* **ws_raster_2km**: rasterized version of the same object above
* four functions used for conversions and to load the raw MAIAC data

Let's take a brief aside to set colors for use in upcoming plots...

```{r breaks_and_colors, include=FALSE}
breaks_bs <- c(-10000,1,5,10,20,40,90,140,350,525,10000)
red_bs <- c(255,255,255,255,255,255,255,200,150)/255
green_bs <- c(225,195,165,135,105,75,46,2,3)/255
blue_bs <- c(225,195,165,135,105,75,45,3,3)/255
colors_bs <- c('transparent',grDevices::rgb(red=red_bs, green=green_bs, blue=blue_bs))

breaks_maiac <- seq(0, .225, length.out = 10)
colors_maiac <- RColorBrewer::brewer.pal(9,'YlOrRd')
colorIndex <- .bincode(maiac$aot, breaks_maiac, include.lowest=TRUE)
```

So, we have rasterized model data which we want to compare to MAIAC swath data. The easiest way to do this will be convert both to raster objects. We have already converted the bluesky data to rasterBrick but we need to do the same with the MAIAC swath data (though technically this will become a rasterLayer, not a rasterBrick, since the swath data only has one time slice). Let's do that now, using the `rasterize()` function. We'll put it on the same grid as the 2-km raster object.

```{r}
maiacGrid <- rasterize(x=maiac[c("longitude","latitude")], y=ws_raster_2km, field=maiac$aot)
```

Here's plots to show where we're at:

```{r echo=FALSE}
par(mfrow=c(1,2))
# bluesky data (a single slice of 3D rasterBrick)
plot(ws_raster_2km[[40]], col=colors_bs, breaks=breaks_bs, legend=FALSE, main="bluesky slice (as raster)\nw/ EPA monitors")
map(database="state", add=TRUE)
monitorMap(Sand_monitors, add=TRUE)

# MAIAC swath (as raster)
plot(maiacGrid, col=colors_maiac, breaks=breaks_maiac, main="MAIAC swath (as raster)\nw/ EPA monitors")
map(database="state", add=TRUE)
monitorMap(Sand_monitors, add=TRUE)
```

So, we have all the data we need. But we want to make comparisons, so we should crop the bluesky and monitor data to the same extent as the MAIAC swath so we are working on the same area.

```{r}
# crop bluesky and MAIAC 2km grid rasters to MAIAC swath bounding box
ext <- extent(c(range(maiac$longitude), range(maiac$latitude)))
ws_raster_2km <- crop(ws_raster_2km, ext)
maiacGrid <- crop(maiacGrid, ext)

# crop monitor data
Sand_monitors <- monitor_subset(Sand_monitors, xlim = ext[1:2], ylim = ext[3:4])
```

Now let's create plots to show where we're at.

```{r}
par(mfrow=c(1,2))
# bluesky data (a single slice of 3D rasterBrick)
plot(ws_raster_2km[[40]], col=colors_bs, breaks=breaks_bs, legend=FALSE, main="bluesky slice (as raster)\nw/ EPA monitors")
map(database="state", add=TRUE)
monitorMap(Sand_monitors, add=TRUE)

# MAIAC swath (as raster)
plot(maiacGrid, col=colors_maiac, breaks=breaks_maiac, main="MAIAC swath (as raster)\nw/ EPA monitors")
map(database="state", add=TRUE)
monitorMap(Sand_monitors, add=TRUE)
```

OK, so now we have the following in memory, among other things:

* **Bluesky aggregate**: 2-km CANSAC-based model output, with data aggregated from runs 2016072112 to 20160726. We have saved this in the following formats:
    + ws_grid (`ws_grid_2km`)
    + ws_raster (`ws_raster_2km`) -- a rasterBrick

* **MAIAC swath**: a single swath from the 7/21/16 afternoon-ish pass of the AQUA satellite. We have saved this in the following formats:
    + dataframe (`maiac`)
    + rasterLayer, on CANSAC 2-km grid (`maiacGrid`)

* **Monitor Data**: EPA monitor data from 20160721 to 20160727, from EPA codes 88101 and 88502. This has been saved as a single `ws_monitor` object.

In an effort to speed up the data exploration process, I am wrapping the processing steps above into the `createSandFiresData.R` script. That way, I can more easily get everything set up, as this alone has been a hurdle to me in the past few weeks. So, running this script now will get all the data and colors set up as shown above, but done in one single line of code instead of several dozen.
