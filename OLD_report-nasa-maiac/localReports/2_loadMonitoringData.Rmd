---
title: "Monitoring Data"
author: "Helen Miller"
date: "6/8/2018"
output: html_document
params:
  spatialDataDir: "~/Data/Spatial"
  maiacDataDir: "~/Data/maiac"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.path = 'monitoringData_figures/', fig.keep = 'high' )
# Load packages
library(AirfireNasaMaiac)
library(PWFSLSmoke)
library(PWFSLSmokeModeling)
library(raster)
logger.setup()

# Load data
setSpatialDataDir(params$spatialDataDir)
setMaiacDataDir(params$maiacDataDir)

loadSpatialData("USCensusStates")

napaFiles <- list.files("../localData", pattern = "napa_*", full.names = TRUE)
for (file in napaFiles) {
  load(file)
}
```



In this notebook, we load monitoring data and do some visualization and analysis of how the variation and distributions of the two datasets compare. 

## Context Map

```{r context_map}
knitr::opts_chunk$set() 
# Load full original raster for Oct 8 aqua
oct08Afull <- maiac_loadRaster("h01v04", 20171008, 2105, converterPath = "../executables/h4toncff_nc4") 

# Define some colors to represent AOD 
colors <- colorRampPalette(c("white", "orange", "red"))(9)
# Breaks for coloring (relatively arbitrary at this point -- just based on what looks best visually)
breaks <- c(0, 0.03, 0.1, 0.2, 0.3, 0.5, 0.8, 10)

# Reproject states polygons to projection of MAIAC data for context map
aeaStates <- spTransform(USCensusStates, CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84"))
# Point for the city of Napa (reprojected for context map)
napa <- SpatialPoints(data.frame(x = -122.2869, y = 38.2975), proj4string = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  spTransform(CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84")) 
# Rectangle to show cropped area
crop <- SpatialPoints(data.frame(x = c(-125.52, -117.03, -117.03, -125.52, -125.52), y = c(36.52, 36.52, 41.78, 41.78, 36.52)), 
                        proj4string = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>%
  spTransform(CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84"))

# Draw the context map
plot(aeaStates, xlim = c(-3e+06, -1e+06), ylim = c(1e+06, 3e+06))
plot(oct08Afull, breaks = breaks, col = colors, colNA = "gray90", main = "Full data extent", add = TRUE, legend = FALSE)
plot(aeaStates, add = TRUE)
rect(xmin(oct08Afull), ymin(oct08Afull), xmax(oct08Afull), ymax(oct08Afull))
text(xmin(oct08Afull), ymax(oct08Afull), "tile extent", pos = 3)
polygon(coordinates(crop)[,1], coordinates(crop)[,2] )
text(coordinates(crop)[1,1], coordinates(crop)[1,2], "cropped \nextent", pos = 1)
plot(napa, add = TRUE)
text(xmin(napa), ymin(napa), "Napa", pos = 3)
```

## Load monitoring data

Monitoring data is loaded from AirNow, WRCC, and AIRSIS. Monitors not in the area of interest are excluded. 

```{r loadingMonitoringData, echo=FALSE}
airnow <- airnow_load(2017)
wrcc <- wrcc_load(2017)
airsis <- airsis_load(2017)
all_monitors <- monitor_combine(list(airnow, wrcc, airsis))
monitors <- monitor_subset(all_monitors, xlim = c(-125.52, -117.03), ylim = c(36.52, 41.78))
fireMonitors <- monitor_subset(monitors, tlim = c(20171008, 20171014))
```

## Maps

These maps show the satellite data, with points for each monitor overlayed and colored according to the AQI color based on the 3-hour centered rolling mean at 19:00 UTC for TERRA and 21:00 UTC for AQUA. In general, it appears that high values for AOT tend to correspond to high monitor values for PM25.

```{r plottingData}
# automatically-generated color palatte
colors <- colorRampPalette(c("white", "orange", "red"))(9)

# define breaks for colors
breaks <- c(0, 0.03, 0.1, 0.2, 0.3, 0.5, 0.8, 3)

rasterList <- list(AQUA_08, TERRA_08, AQUA_09, TERRA_09, AQUA_10, TERRA_10, AQUA_11, TERRA_11, AQUA_12, TERRA_12, AQUA_13, TERRA_13)
for ( i in 1:6 ) {
  AQUA <- rasterList[[i*2 - 1]]$corrected
  TERRA <- rasterList[[i*2]]$corrected
  
  # Get the day of the month as a zero-padded string for printing and selecting the correct value from monitoring data
  day <- stringr::str_pad(i+7, 2, "left", "0")
  
  # Map satellite image
  plot(TERRA, breaks = breaks, col = colors, colNA = "gray90", alpha = .8, main = paste0("TERRA ", "Oct ", day, ", 2017"), legend = FALSE)
  plot(USCensusStates, add = TRUE)
  
  # Add monitors on top, colored based on the AQI category of the 3-hour centered rolling mean at the time of the satellite data collection
  monitor_subset(fireMonitors, tlim = paste0("201710", day, c("19", "20")) ) %>% 
    monitorMap(add = TRUE)
  
  # Do the same for AQUA
  plot(AQUA, breaks = breaks, col = colors, colNA = "gray90", alpha = .8, main = paste0("AQUA ", "Oct ", day, ", 2017"), legend = FALSE)
  plot(USCensusStates, add = TRUE)
  monitor_subset(fireMonitors, tlim = paste0("201710", day, c("21", "22")) ) %>% 
    monitorMap(add = TRUE)
}
```

## Comparing values

For the next plots, monitor values at the time of the satellite data collection are plotted against the MAIAC AOT values at those locations. These plots include all values for each satellite for October 8 - 13.


```{r scatterplots}
dfa <- subset(dfall, dfall$instrument == "aqua" )
dft <- subset(dfall, dfall$instrument == "terra")

# Run a linear regresion for each dataset
lmaqua <- lm(dfa$monitor~dfa$satellite)
lmterra <- lm(dft$monitor~dft$satellite)
lmall <- lm(dfall$monitor~dfall$satellite)

# Scatterplots for each dataset, with the linear best fit line, equation, and r-squared value
plot(dfa$satellite, dfa$monitor, main = "Oct 08-13 21:00 UTC (AQUA)", xlab = "satellite data (AOT)", ylab = "monitoring data (PM2.5 ug/m3)", xlim = c(0,2), ylim = c(0,300))
abline(lmaqua)
text(.35, 275, paste0("y = ", round(lmaqua$coefficients[1], 2), " + ", round(lmaqua$coefficients[2], 2), "x"), pos = 3)
text(.35, 275, paste0("adjusted r-squared = ", round(summary(lmaqua)$adj.r.squared, 2)), pos = 1)
plot(dft$satellite, dft$monitor, main = "Oct 08-13 19:00 UTC (TERRA)", xlab = "satellite data (AOT)", ylab = "monitoring data (PM2.5 ug/m3)", xlim = c(0,2), ylim = c(0,300))
abline(lmterra)
text(.35, 275, paste0("y = ", round(lmterra$coefficients[1], 2), " + ", round(lmterra$coefficients[2], 2), "x"), pos = 3)
text(.35, 275, paste0("adjusted r-squared = ", round(summary(lmterra)$adj.r.squared, 2)), pos = 1)
plot(dfall$satellite, dfall$monitor, main = "Oct 08-13 AQUA and TERRA", xlab = "satellite data (AOT)", ylab = "monitoring data (PM2.5 ug/m3)", xlim = c(0,2), ylim = c(0,300))
abline(lmall)
text(.35, 275, paste0("y = ", round(lmall$coefficients[1], 2), " + ", round(lmall$coefficients[2], 2), "x"), pos = 3)
text(.35, 275, paste0("adjusted r-squared = ", round(summary(lmall)$adj.r.squared, 2)), pos = 1)
```

