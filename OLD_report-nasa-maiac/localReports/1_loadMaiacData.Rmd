---
title: "Loading MAIAC Data"
author: "Helen Miller"
date: "6/7/2018"
output: html_document
params:
  spatialDataDir: "~/Data/Spatial"
  maiacDataDir: "~/Data/maiac"
---
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, fig.path = 'loadMaiacData_figures/', fig.keep = 'high')
# Load packages
library(AirfireNasaMaiac)
library(PWFSLSmoke)
library(PWFSLSmokeModeling)
logger.setup()

# Load data
setSpatialDataDir(params$spatialDataDir)
setMaiacDataDir(params$maiacDataDir)

loadSpatialData("USCensusStates")

napaFiles <- list.files("../localData", pattern = "napa_*", full.names = TRUE)
for (file in napaFiles) {
  load(file)
}
```

In this notebook, we load and visualize MAIAC AOT data for the spatial and temporal extent of the Napa Valley 2017 fires, which were ignited the evening of October 8 and generally had disappeared by a week later. For a more detailed explanation on how the data is loaded into R, see localNotebooks/maiac_0429_loadingData.html. The R/ folder includes several functions for loading and converting MAIAC data from the database, which are used here. They are all of the format 'maiac_...'. 

## Converting and loading data

This folder `R` contains .R files with functions for downloading, converting, and loading MAIAC files. Some documentation for each function can be found in these files. The wrapper for all of this is `maiac_loadRaster()`, which loads the data as a Raster* object using the `raster` package, which provides a wealth of functionality for working with raster data. For example, this would load the TERRA data from October 8, project it to lat/lon coordinates, and crop it to a bounding box:

```{r loadingexample, echo = TRUE, eval = FALSE}
oct08 <- maiac_loadRaster("h01v04", 20171008, 1930, product = "MAIACTAOT") %>% 
  projectRaster(crs = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  crop(raster::extent(-125.52, -117.03, 36.52, 41.78))
```

`maiac_loadRaster()` first calls `maiac_downloadNorthAmerica()` to find the requested file -- if found locally, the local version is loaded -- if not, the file is downloaded. 

Then, it calls `maiac_2nc4()` to convert the HDF file into a netcdf file. If the .nc file already exists locally, it is loaded.

Metadata about the projection and extent is loaded using `maiac_getMetadata()`. This information is used to load the netcdf data into a raster object using the `raster` package.

Currently, `maiac_loadRaster()` always creates the raster object with the same default projection. It may be possible to build the proj4 string to define the projection based on the metadata, or allow the user to specify the proper projection which would allow for loading data with a different projection. 

The projection information used in this function is (as a proj4 string): `+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84`
This is based on information found in the [HDF-EOS Library Users Guide](https://newsroom.gsfc.nasa.gov/sdptoolkit/docs/HDF-EOS_REF.pdf) and the file metadata. More detials about how satellite data is processed can be found in /localNotebooks/maiac_0419_loadingData.html.

For the analysis, data is loaded from the AQUA and TERRA satellites for October 10-13, projected onto a lat/lon coordinate system, cropped to the area of interest, and some spatial smoothing is applied, which is explained later. The script for loading and cleaning the data can be found at `R/createNapaFiresData`, and can be called as a function with arguments for the output directory where the data is to be saved, and the directory where MAIAC files are to be stored locally. 

*note: for most days, there are multiple options of satellite data files for the same extent. If this is the case, maiac_loadRaster will retun an error, with the names of the two files, and the hour must be specified to return a dataset. The options for valid hours can be found in the file name, which is included in the error message.*

## Context Map

This map shows the full extent of the MAIAC tile, with a box around the cropped area that was used for analysis. The satellite data was in a projected refence system, so it is transformed to a lat/long system to match monitoring and bluesky data, which is why the cropped area appears rotated. 

```{r context_map}
# Load full original raster for Oct 8 aqua
oct08Afull <- maiac_loadRaster("h01v04", 20171008, 2105, converterPath = "../executables/h4toncff_nc4") 

# Define some colors to represent AOD 
colors <- colorRampPalette(c("white", "orange", "red"))(9)
# Breaks for coloring (relatively arbitrary at this point -- just based on what looks best visually)
breaks <- c(0, 0.03, 0.1, 0.2, 0.3, 0.5, 0.8, 10)

# Reproject states polygons to projection of MAIAC data for context map
aeaStates <- spTransform(USCensusStates, CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84"))
# Point for the city of Napa (reprojected for context map)
napa <- SpatialPoints(data.frame(x = -122.2869, y = 38.2975), proj4string = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>% 
  spTransform(CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84")) 
# Rectangle to show cropped area
crop <- SpatialPoints(data.frame(x = c(-125.52, -117.03, -117.03, -125.52, -125.52), y = c(36.52, 36.52, 41.78, 41.78, 36.52)), 
                        proj4string = CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0")) %>%
  spTransform(CRS("+proj=aea +lat_1=20 +lat_2=60 +lon_0=-96 +lat_0=23 +datum=WGS84 +ellps=WGS84"))

# Draw the context map
plot(aeaStates, xlim = c(-3e+06, -1e+06), ylim = c(1e+06, 3e+06))
plot(oct08Afull, breaks = breaks, col = colors, colNA = "gray90", main = "Full data extent", add = TRUE, legend = FALSE)
plot(aeaStates, add = TRUE)
rect(xmin(oct08Afull), ymin(oct08Afull), xmax(oct08Afull), ymax(oct08Afull))
text(xmin(oct08Afull), ymax(oct08Afull), "tile extent", pos = 3)
polygon(coordinates(crop)[,1], coordinates(crop)[,2] )
text(coordinates(crop)[1,1], coordinates(crop)[1,2], "cropped \nextent", pos = 1)
plot(napa, add = TRUE)
text(xmin(napa), ymin(napa), "Napa", pos = 3)
```


## Side-by-side plots

There are one or two entries each day for each of TERRA and AQUA. In general, when there are two entries, one of them is missing a lot of data. Through trial-and-error, I have found that for AQUA, the entry timestamped closer to 21:00 UTC or 2:00pm PDT is more complete, and for TERRA, the entry timestamped closer to 19:00 UTC or 12:00pm PDT is more complete. Thus, there is about a 2-hour difference in the satellite data. AOT ranges from 0 to about 2. 

```{r sideBySideMaps}

rasterList <- list(AQUA_08, TERRA_08, AQUA_09, TERRA_09, AQUA_10, TERRA_10, AQUA_11, TERRA_11, AQUA_12, TERRA_12, AQUA_13, TERRA_13)
par(mfcol = c(1,2))
for ( i in 1:6 ) {
  AQUA <- rasterList[[i*2 - 1]]$corrected
  TERRA <- rasterList[[i*2]]$corrected
  day <- stringr::str_pad(i+7, 2, "left", "0")
  plot(TERRA, breaks = breaks, col = colors, colNA = "gray90", alpha = .8, main = "TERRA", legend = FALSE)
  plot(USCensusStates, add = TRUE)
  mtext(paste0("Oct ", day), 2, 3, font = 2)
  plot(AQUA, breaks = breaks, col = colors, colNA = "gray90", alpha = .8, main = "AQUA", legend = FALSE)
  plot(USCensusStates, add = TRUE)
}
```

In general, the two entries look pretty similar, which we would expect from only a two-hour difference. On October 10 and October 11, there is a fair amount of missing data in both entries, possibly due to cloud cover. However, having two entries will help fill in some gaps. 

## Difference Plots

These plots show the difference from TERRA to AQUA, so increases in a particular area indicate that that location became smokier in the two hours between the two entries. Units are difference in AOT. In general, there are not very dramatic changes except near smoke-heavy locations. In particular, on October 9, large changes--both positive and negative--indicate that there was significant advection of smoke between noon and 2pm on that day. 

Since there are changes between the two satellite readings, we should not treat them interchangably when comparing to hourly monitoring or modeling data. Instead, we should only use hourly data from the correct time period. 

```{r differenceplots}
# Define colors and breaks
colors <- colorRampPalette(c("blue", "white", "red"))(9)
breaks <- c(-5, -1, -.5, -.25, -.1, .1, .25, .5, 1, 5)
par(mar = c(3.1, 3.1, 4.1, 4.1))

for ( i in 1:6 ) {
  # Pull out the correct rasters from the correct days
  AQUA <- rasterList[[i*2 - 1]]$corrected
  TERRA <- rasterList[[i*2]]$corrected
  
  # Get zero-padded string for day
  day <- stringr::str_pad(i+7, 2, "left", "0")
  
  # Plot the difference
  plot(AQUA-TERRA, col = colors, breaks = breaks, colNA = "gray90", alpha = .8, main = paste0("Oct ", day), legend = FALSE)
  plot(USCensusStates, add = TRUE)
  
  # Manually add legend to the right side
  usr <- par("usr")
  legendbrks <- seq(usr[3], usr[4], length = length(breaks))
  lx <- usr[2] + .6
  rx <- usr[2] + .75
  rect(lx,
       head(legendbrks, -1),
       rx,
       tail(legendbrks, -1),
       col = colors,
       xpd = NA)
  axis(4, at = legendbrks, labels = breaks, pos = rx, las = 2)
  mtext("AQUA - TERRA (~ change noon to 2pm)", 4, line = 0.2)
}
```

For October 09, compare the difference map with the the 
[visual imagery](https://earthobservatory.nasa.gov/IOTD/view.php?id=91103).

