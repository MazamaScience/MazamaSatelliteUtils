---
title: "Visualizing GOES AOD"
author: "Mazama Science"
date: "4/21/2021"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualizing GOES AOD}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This article will walk through how to plot GOES AOD scans using high-level 
functions available in the **MazamaSatelliteUtils** package.

## Point and Raster Plots 

Each GOES scan records the AOD and data quality values of millions of locations 
across the continental US. **MazamaSatelliteUtils** allows you to visualize this
data either as points using `goesaodc_plotScanPoints()` or as a raster with 
`goesaodc_plotScanRaster()`. Points and rasters each have their upsides and 
downsides when it comes to plotting.

### Point Plots

**Pros:**

- Points display raw (unaggregated) AOD values at the exact location where they 
were sampled (highest possible resolution).
- Render very fast in both Mercator-projected and Cartesian coordinate systems.

**Cons:**

- The arrangement of sample locations means points will likely overlap or have 
gaps between them.
- Point size is not determined by axis units. Therefore, the user will have to 
manually determine the best point size for each plot they make depending on the
area it covers (large area needs smaller points, small area needs larger 
points).

### Raster Plots

**Pros:**

- Cells aggregate multiple points in a small region, and therefore help fill 
'gaps' of `NA` AOD values.
- Cell size is defined using axis units, and cells will never overlap of have
gaps between them. Therefore, the user does not have to adjust anything 
depending on the size of the area the plot covers.

**Cons:**

- Cells will not be as precise (both in raw AOD value and location) as points,
unless the grid resolution is _very_ high.
- High-resolution rasters render very slowly on Mercator-projected coordinate 
systems.

## Plotting Steps

The basic steps to visualizing GOES AOD data is to:

1. Generate a points/raster object with `goesaodc_createScanPoints()` or
`goesaodc_createScanRaster()`. You can filter this data by location and quality 
level.
2. Draw the points/raster object with `goesaodc_plotScanPoints()` or 
`goesaodc_plotScanRaster()`.

The `goesaodc_createScan*()` functions require that you identify one or more 
scans to turn into a points/raster object. There are 2 ways you can do this:

1. Setting the `satID` and `datetime` parameters. These will be used to find the 
scan taken closest to that time by the given satellite. If `endtime` is set as
well, then all scans taken from `datetime` up to (but not including) `endtime`
will be gathered and have their corresponding sample readings averaged. You can
set the timezone of `datetime` and `endtime` with the `timezone` parameter.
Otherwise, they will be interpreted in UTC.

2. Setting the `filename` parameter to the name of a single scan file. Multiple
file names cannot be given since they might not be in chronological order.

## Plotting Points

Point plots are fast and precise, so they are great for getting a quick visual 
of AOD data. For that reason, let's start our exploration with point plots. Our
first step is to load the **MazamaSatelliteUtils** package and specify a 
directory to store downloaded GOES scan files.

```{r}
# Set up library
library(MazamaSatelliteUtils)
setSatelliteDataDir("~/Data/Satellite")
```

Now let's create a `SpatitialPointsDataFrame` for a scan specified by satellite 
ID + time and then plot it. This example takes a look at the Oregon fires in 
September, 2020, as seen by GOES-17:

```{r fig.width=7, fig.height=5, fig.align="center"}
bboxOregon <- c(-125, -116, 42, 46.5)

scanPoints <- goesaodc_createScanPoints(
  satID = "G17",
  datetime = "2020-09-08 9:00",
  timezone = "America/Los_Angeles",
  bbox = bboxOregon
)

goesaodc_plotScanPoints(
  spdf = scanPoints,
  bbox = bboxOregon,
  title = "Oregon AOD at 9:00am PDT on Sept. 8, 2020"
)
```

This image isn't very useful without some geographic context. The 
`goesaodc_plotScanPoints()` and `goesaodc_plotScanRaster()` functions allow 
users to draw overlying state outlines as well as underlying topographical map
images (points can be made transparent with `pointAlpha`). You can also use a
discrete color palette by passing in an RColorBrewer `paletteName` and a vector
of `paletteBreaks`.

Let's try all these out, but this time using a `filename`. It's quite a bit 
faster to make a plot of a file you know in advance!

```{r warning=FALSE, message=FALSE, fig.width=7, fig.height=5, fig.align="center"}
library(MazamaSpatialUtils)
setSpatialDataDir("~/Data/Spatial")
loadSpatialData("NaturalEarthAdm1")

# Get the name of the scan file taken closest to 9am on 2020-09-08 by GOES-17
scanFilename <- MazamaSatelliteUtils::goesaodc_listScanFiles(
  satID = "G17",
  datetime = "2020-09-08 9:00",
  timezone = "America/Los_Angeles",
  useRemote = TRUE
)

scanPoints <- goesaodc_createScanPoints(
  filename = scanFilename,
  bbox = bboxOregon
)

goesaodc_plotScanPoints(
  spdf = scanPoints,
  bbox = bboxOregon,
  pointAlpha = 0.5,
  paletteName = "Blues",
  paletteBreaks = c(-Inf, 0, 1, 2, 3, 4, 5, Inf),
  includeMap = TRUE,
  zoom = 7,
  stateCodes = "OR"
)
```

It may not be obvious for this specific region, but including a map image forces
the plot to use a Mercator projected coordinate system instead of a linear 
Cartesian one. This allows the AOD points and state lines to match up with the
underlying map image (which itself is Mercator projected).

Another important thing to note is the `dqfLevel` parameter. Every point with
a DQF flag above this level will have its AOD value replaced with `NA`:

```{r fig.width=7, fig.height=5, fig.align="center"}
goesaodc_plotScanPoints(
  spdf = scanPoints,
  bbox = bboxOregon,
  stateCodes = "OR"
)
```

You can also limit the palette range covered in the color legend with the 
`legendLimits` parameter. Every point with an AOD value outside of this range
will be drawn in the `NA` color:

```{r fig.width=7, fig.height=5, fig.align="center"}
goesaodc_plotScanPoints(
  spdf = scanPoints,
  bbox = bboxOregon,
  legendLimits = c(0, 4),
  stateCodes = "OR"
)
```

Being a point plot function, `goesaodc_plotScanPoints()` allows you to set 
`pointShape` and `pointSize`. `pointShape` is an integer from 0 to 25 used in 
the same way as `pch` in R's base `plot()` function. `pointSize` is the size of 
the point shape in mm, _not_ axis units.

```{r fig.width=7, fig.height=5, fig.align="center"}
goesaodc_plotScanPoints(
  spdf = scanPoints,
  bbox = c(-123, -121, 45, 46),
  pointShape = 1,
  pointSize = 2,
  stateCodes = "OR"
)
```

Lastly, let's demonstrate what an averaged multi-scan points plot looks like:

```{r fig.width=7, fig.height=5, fig.align="center"}
averagedScanPoints <- goesaodc_createScanPoints(
  satID = "G17",
  datetime = "2020-09-08 9:00",
  endtime = "2020-09-08 10:00",
  timezone = "America/Los_Angeles",
  bbox = bboxOregon
)

goesaodc_plotScanPoints(
  spdf = averagedScanPoints,
  bbox = bboxOregon,
  stateCodes = "OR"
)
```

## Plotting Rasters

`goesaodc_plotScanRaster()` defines a spatial grid and aggregates the AOD of the
scan points that fall into each grid cell. Users are required to pass in a
`cellSize` that defines the dimensions of each grid cell in lon/lat degrees.

```{r fig.width=7, fig.height=5, fig.align="center"}
scanRaster <- goesaodc_createScanRaster(
  filename = scanFilename,
  bbox = bboxOregon,
  cellSize = 0.05,
)

goesaodc_plotScanRaster(
  raster = scanRaster,
  bbox = bboxOregon,
  stateCodes = "OR"
)
```

`goesaodc_plotScanRaster()` has all the same aesthetic options as 
`goesaodc_plotScanPoints()`, except that is uses `rasterAlpha` instead of 
`pointAlpha` and has no `pointSize` or `pointShape` parameters. However, 
remember how the coordinate system is Mercator-projected when a map image is
drawn? This significantly effect raster draw speed since every cell has to be 
warped to fit the projection. High resolution rasters can therefore take a while
to render.

```{r warning=FALSE, fig.width=7, fig.height=5, fig.align="center"}
goesaodc_plotScanRaster(
  raster = scanRaster,
  bbox = bboxOregon,
  includeMap = TRUE,
  zoom = 7,
  stateCodes = "OR"
)
```

## Animations

`goesaodc_plotScanPoints()` and `goesaodc_plotScanRaster()` allow you to plot 
static images of GOES AOD data. You can create animated videos of AOD as well 
using the `goesaodc_animateScanPoints_exec.R` and 
`goesaodc_animateScanRaster_exec.R` executable scripts. These scripts take in 
the same parameters as their plot counterparts (except `datetime` is now 
`starttime`), but they require several additional arguments:

* `satelliteDataDir`: The directory where satellite data is downloaded to and 
read from.
* `spatialDataDir`: The directory where spatial data is downloaded to and read 
from.
* `outputDir`: The directory where the video should be saved to.
* `logDir`: The directory where the output log files should be saved to.
* `frameRate`: The framerate of the video in fps.
* `verbose`: A logical flag whether to print out progress messages in the 
console.
* `version`: A logical flag whether to print out the current version of the 
executable script.

Another thing to note: Since animations are made up of individual plots, it's
essential that they all share a consistent color legend so that the color scale 
bounds don't change between frames and that the legend should still be drawn 
even if all the AOD values for a frame are `NA`. This is achieved by _requiring_
the user to set the `legendLimits` parameter.

Here's an example of animating points:

```
./animateScanPoints_exec.R \
  --satID="G17" \
  --starttime="2020-09-08 09:00" \
  --endtime="2020-09-08 10:00" \
  --timezone="America/Los_Angeles" \
  --bbox="-125, -116, 42, 47" \
  --dqfLevel=3 \
  --pointSize=0.3 \
  --pointShape=15 \
  --pointAlpha=0.6 \
  --paletteName="YlOrRd" \
  --legendLimits="-0.5, 5.5" \
  --includeMap=TRUE \
  --zoom=7 \
  --stateCodes="OR" \
  --satelliteDataDir="~/Data/Satellite" \
  --spatialDataDir="~/Data/Spatial" \
  --frameRate=6 \
  --outputDir="~/Downloads" \
  --logDir="~/Downloads" \
  --verbose=TRUE
```

And another for animating rasters:

```
./animateScanPoints_exec.R \
  --satID="G17" \
  --starttime="2020-09-08 09:00" \
  --endtime="2020-09-08 10:00" \
  --timezone="America/Los_Angeles" \
  --bbox="-125, -116, 42, 47" \
  --dqfLevel=3 \
  --cellSize=0.05 \
  --rasterAlpha=0.6 \
  --paletteName="YlOrRd" \
  --legendLimits="-0.5, 5.5" \
  --includeMap=TRUE \
  --zoom=7 \
  --stateCodes="OR" \
  --satelliteDataDir="~/Data/Satellite" \
  --spatialDataDir="~/Data/Spatial" \
  --frameRate=6 \
  --outputDir="~/Downloads" \
  --logDir="~/Downloads" \
  --verbose=TRUE
```
